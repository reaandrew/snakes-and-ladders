pre-commit:
  parallel: true
  jobs:
    - name: lint
      glob: '*.{js,ts,jsx,tsx}'
      run: pnpm eslint {staged_files}
      stage_fixed: true

    - name: format
      glob: '*.{js,ts,jsx,tsx,json,css,md,yml,yaml}'
      run: pnpm prettier --write {staged_files}
      stage_fixed: true

    - name: typecheck
      run: pnpm typecheck

    - name: secrets
      run: |
        if which gitleaks > /dev/null 2>&1; then
          gitleaks protect --staged --verbose
        else
          echo "Note: gitleaks not installed locally. Install with: brew install gitleaks"
          echo "Secret scanning runs in CI regardless."
        fi

commit-msg:
  jobs:
    - name: conventional-commit
      run: |
        message=$(cat {1})
        pattern="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+"
        if ! echo "$message" | grep -qE "$pattern"; then
          echo "Commit message must follow Conventional Commits format:"
          echo "  type(scope): description"
          echo ""
          echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
          exit 1
        fi

pre-push:
  parallel: true
  jobs:
    - name: terraform-format
      glob: 'infrastructure/**/*.tf'
      run: |
        if which terraform > /dev/null 2>&1; then
          terraform fmt -check -recursive infrastructure
        else
          echo "Note: terraform not installed locally."
        fi

    - name: terraform-tfsec
      glob: 'infrastructure/**/*.tf'
      run: |
        if which tfsec > /dev/null 2>&1; then
          tfsec infrastructure --minimum-severity HIGH
        else
          echo "Note: tfsec not installed locally. Install with: brew install tfsec"
          echo "Terraform security scanning runs in CI regardless."
        fi

    - name: terraform-checkov
      glob: 'infrastructure/**/*.tf'
      run: |
        if which checkov > /dev/null 2>&1; then
          checkov -d infrastructure --framework terraform --compact --quiet
        else
          echo "Note: checkov not installed locally. Install with: pip install checkov"
          echo "Checkov scanning runs in CI regardless."
        fi
